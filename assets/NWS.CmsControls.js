NWS.initNamespace("NWS.CmsControls",function(){var _={SetMsg:function(state){let ctl=NWS.Util.Get(state.id),baseNode=NWS.Util.GetBaseNodeForCtl(ctl),errorCtl=NWS.Util.QueryGet(".msg span[id$='_ErrorMsg']",baseNode);if(!ctl||!baseNode||!errorCtl)return;baseNode.classList.remove("changed");baseNode.classList.remove("error");errorCtl.textContent="";if(!state.valid){errorCtl.textContent=state.msg;baseNode.classList.add("error");return}if(state.changed)baseNode.classList.add("changed")},ToggleHelp:function(evt){NWS.Util.QueryGetAll(".help",NWS.Util.GetBaseNodeForCtl(evt.target)).forEach(function(helpMsg){helpMsg.classList.toggle("closed")})},ValidateOneField:function(evt){if(evt.Args===null||evt.Args.Control===undefined)return;if(evt.type==="input")_.checkMulti(evt.Args.Control,true);let state=evt.Args.Control.Validate();if(evt.Args.Control.Collection)evt.Args.Control.Collection.UpdateControlState(state)},IsElementControlable:function(element){if(!element.hasAttribute("data-control-id")||!NWS.Util.Get(element.getAttribute("data-control-id"))){element.removeAttribute("data-control-id");element.removeAttribute("data-field-binding-info");return false}if(!element.hasAttribute("data-field-binding-info"))return false;return true},checkMulti:function(control,isChecked){if(control.Multi)NWS.Util.Get(control.ID+"_multi").checked=isChecked},skipMulti:function(control){return control.Multi&&!NWS.Util.Get(control.ID+"_multi").checked},parseModuleRefs:function(json,cmsControl){let testFuncs=["CmsInitFunction","ValidatorFunction","ErrorMessageFunction","ChangeDetectorFunction","ChangeMessageFunction","DefaultValueExtractor","ValueExtractor","CustomXPathFunction"],hasFuncs=testFuncs.some(func=>json[func]!==undefined&&json[func]!==""),modulesLoaded=testFuncs.filter(func=>json[func]!==undefined&&json[func]!=="").every(func=>NWS.Modules.Parse(json[func]||"",window,"function")!==null);if(hasFuncs&&!modulesLoaded){setTimeout(_.parseModuleRefs,100,json,cmsControl);return}cmsControl.ControlInit=NWS.Modules.Parse(json.CmsInitFunction||"",window,"function");cmsControl.ValidatorFunction=NWS.Modules.Parse(json.ValidatorFunction||"",window,"function");cmsControl.ErrorMessageFunction=NWS.Modules.Parse(json.ErrorMessageFunction||"",window,"function")||function(){return cmsControl.ErrorMessages.custom||"An unknown custom error occurred."};cmsControl.ChangeDetectorFunction=NWS.Modules.Parse(json.ChangeDetectorFunction||"",window,"function");cmsControl.ChangeMessageFunction=NWS.Modules.Parse(json.ChangeMessageFunction||"",window,"function");cmsControl.DefaultValueExtractor=NWS.Modules.Parse(json.DefaultValueExtractor||"",window,"function");cmsControl.ValueExtractor=NWS.Modules.Parse(json.ValueExtractor||"",window,"function");cmsControl.CustomXPathFunction=NWS.Modules.Parse(json.CustomXPathFunction||"",window,"function");_.parseComplete(cmsControl)},parseComplete:function(cmsControl){let ctl=NWS.Util.QueryGet("#"+cmsControl.ID,cmsControl.Container);if(ctl&&_.IsElementControlable(cmsControl.Container)){ctl.Control=cmsControl;if(cmsControl.ChangeDetectorEvent&&cmsControl.ChangeDetectorEvent!=="None"){ctl.addEventListener(cmsControl.ChangeDetectorEvent,NWS.Util.Event.Debounce(300,_.ValidateOneField,{Control:cmsControl}),false);if(cmsControl.Multi)NWS.Util.Get(cmsControl.ID+"_multi").addEventListener("click",function(e){e.Args={Control:cmsControl};_.ValidateOneField(e)},false)}if(ctl.hasAttribute("data-messages")){cmsControl.ErrorMessages=JSON.parse(ctl.getAttribute("data-messages"));ctl.removeAttribute("data-messages")}NWS.Util.QueryGetAll(".help .icon",cmsControl.Container).forEach(function(icon){icon.addEventListener("click",_.ToggleHelp,false)});if(cmsControl.ControlInit!==null)cmsControl.ControlInit(cmsControl)}cmsControl.Container.removeAttribute("data-field-binding-info");cmsControl.Container.removeAttribute("data-control-id")},escapeCData:function(value){if(!value)return"";return value.replace(/<(!\x5BCDATA\x5B)([\w\W]*)(\x5D\x5D)>/gi,"&lt;$1$2$3&gt;")}};function Control(div,prefix){let json=JSON.parse(div.getAttribute("data-field-binding-info"));this.ID=div.getAttribute("data-control-id");this.Prefix=prefix||"";if(this.Prefix!==""&&!this.ID.startsWith(this.Prefix)){let newID=this.Prefix+this.ID,ctl=NWS.Util.QueryGet("#"+this.ID,div);if(ctl)ctl.id=newID;NWS.Util.QueryGetAll("label[for='"+this.ID+"'], input[name='"+this.ID+"'], span[id='"+this.ID+"_ErrorMsg'], input[id^='"+this.ID+"'][type='text']",div).forEach(element=>{if(element.hasAttribute("for"))element.setAttribute("for",newID);else if(element.hasAttribute("name"))element.setAttribute("name",newID);else if(element.id.endsWith("_ErrorMsg"))element.id=newID+"_ErrorMsg";else if(element.hasAttribute("id")&&element.id.startsWith(this.ID))element.id=this.Prefix+element.id});div.setAttribute("data-control-id",newID);this.ID=newID}this.Container=div;this.FriendlyName=json.FriendlyName;this.XPathName=json.XPathName;this.ChangeDetectorEvent=json.ChangeDetectorEvent;this.Multi=json.IsMulti||false;this.ErrorMessages={};this.UseCData=true;switch(typeof json.UseCData){case"boolean":this.UseCData=json.UseCData;break;case"string":this.UseCData=json.UseCData==="true"||json.UseCData==="1"||json.UseCData==="yes";break;case"number":this.UseCData=json.UseCData===1;break}_.parseModuleRefs(json,this,div)}Control.prototype.Validate=function(){let retVal={id:this.ID,valid:true,changed:false,msg:""},element=NWS.Util.QueryGet('#'+this.ID,this.Container);if(NWS.Fields.State.IsDisabled(this.ID,this.Container)){retVal.msg="Field disabled";return retVal}else if(!element){retVal.msg="No such element";return retVal}_.SetMsg(retVal);element.removeAttribute("data-invalid");element.checkValidity&&element.setCustomValidity("");if(_.skipMulti(this))return retVal;retVal.valid=element.checkValidity?element.checkValidity():true;retVal.changed=this.HasChanged();retVal.msg=!retVal.valid?this.ErrorMessage():"";if(!retVal.valid){_.SetMsg(retVal);return retVal}if(this.ValidatorFunction&&!this.ValidatorFunction(this.ID,this.Container)){retVal.valid=false;element.setAttribute("data-invalid","custom");element.checkValidity&&element.setCustomValidity("ERROR")}let customFuncs=Object.keys(this.ErrorMessages).filter(k=>k.startsWith("custom-")&&k.endsWith("-function"));if(!this.ValidatorFunction&&customFuncs.length){for(let ii=0;ii<customFuncs.length;ii++){let func=NWS.Modules.Parse(this.ErrorMessages[customFuncs[ii]],window,"function");if(func&&!func(this.ID)){retVal.valid=false;element.setAttribute("data-invalid",customFuncs[ii].substring(0,customFuncs[ii].length-9));element.checkValidity&&element.setCustomValidity("ERROR");break}}}retVal.msg=!retVal.valid?this.ErrorMessage():"";_.SetMsg(retVal);return retVal};Control.prototype.HasChanged=function(){if(this.Multi)return NWS.Util.QueryGet('#'+this.ID+"_multi",this.Container).checked;if(NWS.Fields.State.IsDisabled(this.ID,this.Container))return false;return this.ChangeDetectorFunction?this.ChangeDetectorFunction(this.ID,this.Container):false};Control.prototype.ErrorMessage=function(){let element=NWS.Util.QueryGet('#'+this.ID,this.Container),validity=element.checkValidity?element.validity:null;if(!element.hasAttribute("data-invalid")&&(validity===null||validity.valid))return"";if(validity===null&&element.hasAttribute("data-invalid")&&NWS.Util.GetClosest(element,".AdminItem, .AdminOne")!==null){element.removeAttribute("data-invalid");return""}else if(validity===null&&element.hasAttribute("data-invalid")&&this.ErrorMessages[element.getAttribute("data-invalid")]){return this.ErrorMessages[element.getAttribute("data-invalid")]}else if(validity===null&&element.hasAttribute("data-invalid")){element.removeAttribute("data-invalid");return""}if(validity.valueMissing)return this.ErrorMessages.required?this.ErrorMessages.required:"Value is required.";if(validity.patternMismatch)return this.ErrorMessages.pattern?this.ErrorMessages.pattern:"Value does not match pattern.";if(validity.typeMismatch)return this.ErrorMessages.type?this.ErrorMessages.type:"Value does not match expected type";if((validity.customError||element.hasAttribute("data-invalid"))&&this.ErrorMessages[element.getAttribute("data-invalid")])return this.ErrorMessages[element.getAttribute("data-invalid")];return this.ErrorMessageFunction(this.ID,this.FriendlyName)};Control.prototype.ChangedMessage=function(){if(_.skipMulti(this))return"";return this.ChangeMessageFunction?this.ChangeMessageFunction(this.ID,this.FriendlyName):""};Control.prototype.DefaultValue=function(){return this.DefaultValueExtractor?this.DefaultValueExtractor(this.ID,this.Container):null};Control.prototype.Value=function(){if(NWS.Fields.State.IsDisabled(this.ID,this.Container))return null;let retVal=this.CustomXPathFunction?this.CustomXPathFunction(this.ID):(this.ValueExtractor?this.ValueExtractor(this.ID,this.Container):null);return this.UseCData?_.escapeCData(retVal):retVal};function ControlCollection(name,selector,baseNode,prefix){this.Name=name;this.Prefix=prefix||"";this.Controls=[];this.ControlNames=[];this.Errors=[];this.Changes=[];if(!selector)return;let initFunc=function(element){if(!_.IsElementControlable(element))return;let cmsControl=new Control(element,prefix);cmsControl.Collection=this;this.Controls.push(cmsControl);this.ControlNames.push(cmsControl.ID)}.bind(this);NWS.Util.QueryGetAll(selector,baseNode).forEach(initFunc)}ControlCollection.prototype.InitControl=function(name,selector,baseNode){let element=NWS.Util.QueryGet(selector,baseNode);if(!element||!_.IsElementControlable(element))return;let cmsControl=new Control(element,this.Prefix);cmsControl.Collection=this;let idx=this.ControlNames.indexOf(name);if(idx===-1){this.Controls.push(cmsControl);this.ControlNames.push(name)}else this.Controls[idx]=cmsControl};ControlCollection.prototype.InitFromElements=function(elements){if(!Array.isArray(elements))return;let initFunc=function(element){if(!_.IsElementControlable(element))return;let cmsControl=new Control(element,this.Prefix);cmsControl.Collection=this;let idx=this.ControlNames.indexOf(cmsControl.ID);if(idx===-1){this.Controls.push(cmsControl);this.ControlNames.push(cmsControl.ID)}else this.Controls[idx]=cmsControl}.bind(this);elements.forEach(initFunc)};ControlCollection.prototype.Validate=function(scrollTo=false){let states=this.Controls.map(control=>control.Validate());this.Errors=states.filter(state=>!state.valid).map(invalid=>invalid.id);this.Changes=states.filter(state=>state.changed).map(changed=>changed.id);if(scrollTo&&this.Errors.length>0)NWS.Util.ScrollTo(document.getElementById(this.Errors[0]))};ControlCollection.prototype.UpdateControlState=function(state){let errorIdx=this.Errors.indexOf(state.id),changesIdx=this.Changes.indexOf(state.id);if(state.changed&&changesIdx===-1)this.Changes.push(state.id);else if(!state.changed&&changesIdx>=0)this.Changes.splice(changesIdx,1);if(!state.valid&&errorIdx===-1)this.Errors.push(state.id);else if(state.valid&&errorIdx>=0)this.Errors.splice(errorIdx,1)};ControlCollection.prototype.HasChanged=function(){return this.Changes.length!==0};ControlCollection.prototype.IsValid=function(){return this.Errors.length===0};ControlCollection.prototype.GetControlValue=function(xpathName){let control=this.Controls.find(c=>c.XPathName===xpathName);return control?control.Value():null};ControlCollection.prototype.GetChanges=function(format){let retVal=null,mapper=function(name){return this.Controls[this.ControlNames.indexOf(name)]}.bind(this);switch(format){case"json":retVal={};if(this.Name)retVal[this.Name]={};let packager=function(cmsControl){if(this.Name)retVal[this.Name][cmsControl.XPathName]=cmsControl.Value();else retVal[cmsControl.XPathName]=cmsControl.Value()}.bind(this);this.Changes.map(mapper).forEach(packager);break;case"xml":default:retVal=[];retVal.push(NWS.Xml.MakeStartTag(this.Name,null,false));this.Changes.map(mapper).forEach(function(cmsControl){retVal.push(NWS.Xml.MakeTag(cmsControl.XPathName,cmsControl.Value(),null,cmsControl.UseCData))});retVal.push(NWS.Xml.MakeEndTag(this.Name,false));retVal=retVal.join("");break}return retVal};ControlCollection.prototype.PackageData=function(format){let retVal=null;switch(format){case"json":retVal={};if(this.Name)retVal[this.Name]={};let packager=function(cmsControl){let x=this.Name?retVal[this.Name]:retVal;if(x[cmsControl.XPathName]===undefined)x[cmsControl.XPathName]=cmsControl.Value();else if(!Array.isArray(x[cmsControl.XPathName]))x[cmsControl.XPathName]=[x[cmsControl.XPathName],cmsControl.Value()];else if(Array.isArray(x[cmsControl.XPathName]))x[cmsControl.XPathName].push(cmsControl.Value())}.bind(this);this.Controls.forEach(packager);break;case"xml":default:retVal=[];retVal.push(NWS.Xml.MakeStartTag(this.Name,null,false));this.Controls.forEach(cmsControl=>retVal.push(NWS.Xml.MakeTag(cmsControl.XPathName,cmsControl.Value(),null,cmsControl.UseCData)));retVal.push(NWS.Xml.MakeEndTag(this.Name,false));retVal=retVal.join("");break}return retVal};return{Control:Control,ControlCollection:ControlCollection,EnableDisable:function(id,doEnable,container){let ctl=typeof id==="string"?NWS.Util.QueryGet('#'+id,container):id;if(!ctl)return;let wrapper=NWS.Util.GetClosest(ctl,".Field");if(!wrapper)return;if(doEnable)wrapper.classList.remove("disabled");else wrapper.classList.add("disabled");ctl.disabled=!doEnable},HideShow:function(id,doHide){let ctl=NWS.Util.Get(id);if(!ctl)return;let wrapper=NWS.Util.GetClosest(ctl,".Field");if(!wrapper)return;if(doHide)wrapper.classList.add("hide");else wrapper.classList.remove("hide")},SetError:function(id,message){_.SetMsg({id:id,valid:false,msg:message})},InitHelp:function(ctl){if(ctl)ctl.addEventListener("click",_.ToggleHelp,false)},NoValue:function(){return null},DecodeValue:function(id,container){return NWS.Ajax.UrlToken.Decode(NWS.Fields.State.GetValue(id,container))}}})