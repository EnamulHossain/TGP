NWS.initNamespace("NWS.Block.DataEditor",function(){var _={ClientSideCaptchaValidate:function(cmsFormsSuffix,recaptchaDivSuffix){if(!NWS.Util.Get("cmsForms_CommentingCaptchaEnabled_"+cmsFormsSuffix)||NWS.Util.Get("cmsForms_CommentingCaptchaEnabled_"+cmsFormsSuffix).value!=="1")return true;if(!NWS.Util.Get("cmsForms_TitanRatingReCaptchaZone_"+cmsFormsSuffix))return true;if(!NWS.Util.Get("recaptcha-container-"+recaptchaDivSuffix))return true;var recaptchaDisplayType=NWS.Util.Get("recaptcha-container-"+recaptchaDivSuffix).getAttribute("data-displaytype");if(!recaptchaDisplayType||recaptchaDisplayType==='invisible'){return true}else{var tokenContainer=NWS.Util.Get("cmsForms_CaptchaResponseToken_"+cmsFormsSuffix);var recaptchaResponse=grecaptcha.getResponse();if(tokenContainer&&recaptchaResponse)tokenContainer.value=recaptchaResponse;return _.SFRespondToValidation(recaptchaResponse,"titan_captcha","You must respond to the Recaptcha request.","cmsForms_TitanCaptcha",null)}},recaptchaLoadedFunctions:[],RecaptchaLoaded:function(){if(_.recaptchaLoadedFunctions&&Array.isArray(_.recaptchaLoadedFunctions))for(var i=0;i<_.recaptchaLoadedFunctions.length;i++){var recaptchaFunction=_.recaptchaLoadedFunctions[i];if(recaptchaFunction&&typeof recaptchaFunction==='function'){recaptchaFunction()}}},ResetCaptcha:function(widgetSuffix){try{if(window["grecaptcha"]&&grecaptcha.render){var widgetID=NWS.Util.Get('recaptcha-widget-id-'+widgetSuffix).value;grecaptcha.reset(widgetID)}}catch(e){}},ExtractCaptchaInfo:function(containerControl,suffix){if(!window["grecaptcha"])return;var tokenContainer=NWS.Util.Get("cmsForms_CaptchaResponseToken_"+suffix);if(!tokenContainer)return;return NWS.Xml.MakeTag("RecaptchaResponse",tokenContainer.value,null,true)},CheckForInvisibleRecaptchaData:function(docID,blockID,doConfirm,useCaptcha,submitAction){if(!NWS.Util.Get("cmsForms_CommentingCaptchaEnabled_"+blockID)||NWS.Util.Get("cmsForms_CommentingCaptchaEnabled_"+blockID).value!=="1"){_.HandleSubmit(docID,blockID,doConfirm,useCaptcha,submitAction);return}if(!NWS.Util.Get("recaptcha-container-"+blockID)){_.HandleSubmit(docID,blockID,doConfirm,useCaptcha,submitAction);return}var recaptchaDisplayType=NWS.Util.Get("recaptcha-container-"+blockID).getAttribute("data-displaytype");if(recaptchaDisplayType&&recaptchaDisplayType==='invisible'){var recaptchaID=NWS.Util.Get('recaptcha-widget-id-'+blockID).value;grecaptcha.execute(recaptchaID);return}_.HandleSubmit(docID,blockID,doConfirm,useCaptcha,submitAction)},GetFieldContainer:function(target){while(target.nodeName!=="DIV"||!target.attributes["fieldType"]||!target.attributes["fieldName"]){target=target.parentNode;if(!target||!target.nodeName)return null}return target},GetInitData:function(type,fieldID){var inputCtl=NWS.Util.Get(fieldID);if(type==="freeform")return NWS.Util.Get(inputCtl.getAttribute("FieldName")+"_preview").innerHTML;else if(type==="filepicker"){return JSON.stringify({LinkParameter:inputCtl.value,DocumentTypeID:21,TargetTypeID:100})}else{var li=_ItemList.GetSelectedItem(inputCtl.getAttribute("FieldName"));if(!li)return;var nameSpan=li.querySelector("span.name"),prevUrl="",prevType="2",prevNewWin="0",prevLinkedText="";if(li.getAttribute("Value")&&li.getAttribute("Value")!=="1")prevUrl=li.getAttribute("Value");if(li.getAttribute("titan-linkType"))prevType=li.getAttribute("titan-linkType");if(li.getAttribute("titan-usenewwindow"))prevNewWin=li.getAttribute("titan-usenewwindow");if(nameSpan.textContent)prevLinkedText=nameSpan.textContent;else if(nameSpan.innerText)prevLinkedText=nameSpan.innerText;return JSON.stringify({LinkParameter:prevUrl,DocumentTypeID:prevType,TargetTypeID:prevNewWin==="1"?102:100,Text:prevLinkedText})}},HandleSubmit:function(docID,blockID,doConfirm,useCaptcha,submitAction){var processingKey=NWS.Util.Get("cmsFormsControl_"+blockID+"_ProcessingKey"),token=processingKey.getAttribute("token"),key=NWS.Util.Get("cmsForms_"+blockID+"_key").value,data=[];var textareas=NWS.Util.QueryGetAll("div[fieldtype='freeform'], div[fieldtype='xmltextarea']"),itemLists=NWS.Util.QueryGetAll("div[fieldtype='linkpicker'], div[fieldtype='multifilepicker']"),recurringDates=NWS.Util.QueryGetAll("div[fieldtype='datetimerecur']");for(var ta=0;ta<textareas.length;ta++){var id="cmsForms_"+textareas[ta].getAttribute("fieldName");data.push({FieldName:id,FieldValue:NWS.Util.Get(id).value})}for(var il=0;il<itemLists.length;il++){var name=itemLists[il].getAttribute("fieldName"),listID="cmsForms_"+name,xml=_ItemList.PackageData(name,false);NWS.Util.Get(listID).value=(xml!=="")?"1":"";data.push({FieldName:listID,FieldValue:xml})}for(var rd=0;rd<recurringDates.length;rd++){var rdName=recurringDates[rd].getAttribute("fieldName"),rdID="cmsForms_"+recurringDates[rd].getAttribute("fieldName"),rdXml=RecurringDate.PackageData(rdName);document.getElementById(rdID).value=rdXml!==""?"1":"";data.push({FieldName:rdID,FieldValue:rdXml})}let args={encodedData:NWS.Ajax.UrlToken.Encode(JSON.stringify(data)),hash:token,key:key},callback=NWS.Ajax.QueuedCallback("EncodeFieldData"+blockID,function(result){_.SubmitCallback(result,docID,blockID,doConfirm,useCaptcha,submitAction)});NWS.Ajax.Post("/DataEditorDisplayAjax/EncodeFieldData",args,"json",callback)},SubmitCallback:function(ajaxResult,docID,blockID,doConfirm,useCaptcha,submitAction){let response=ajaxResult.response;_.RedirectIfNeeded(ajaxResult.response);if(response&&response.data)NWS.Util.Get("cmsFormsControl_"+blockID+"_decode").value=JSON.stringify(response.data);_.SubmitForm(docID,blockID,doConfirm,useCaptcha,submitAction)},SubmitForm:function(docID,blockID,doConfirm,useCaptcha,submitAction){var isValid=_.SFGeneralValidate(docID,blockID,useCaptcha,window["FormSpecificValidation"]);if(!isValid)return;if(doConfirm==="1")return _.SFConfirmForm(blockID);if(NWS.Wkst.Dialog.GetEditor()!==null&&NWS.Block.DataEditorDialog)NWS.Block.DataEditorDialog.PostValidatePrep();NWS.Block.DataEditor.FinalFormSubmit(docID,blockID,submitAction)},FinalFormSubmitCallback:function(ajaxResult,callback,callbackArgs){_.RedirectIfNeeded(ajaxResult.response);callbackArgs[callbackArgs.length]=ajaxResult.response;NWS.Modules.ExecuteFunctionByName(callback,window,callbackArgs)},RedirectIfNeeded:function(returnData){if(!returnData.statusCode||returnData.statusCode===200)return;var loc=window.location;if(returnData.statusCode===401)loc.reload(true)},HandleProcessingKey:function(blockID){var processingKey=NWS.Util.Get("cmsFormsControl_"+blockID+"_ProcessingKey"),keyField=NWS.Util.Get("cmsForms_"+blockID+"_key");if(processingKey&&keyField){var hash=processingKey.getAttribute("token"),key=keyField.value;keyField.value="";processingKey.innerHTML+=["<input type='text' id='cmsForms_",blockID,"_",key,"' name='cmsForms_",blockID,"_",key,"' value='",hash,"' style='display:none'/>"].join("")}},ResetProcessingKey:function(blockID,decodedFields){var processingKey=NWS.Util.Get("cmsFormsControl_"+blockID+"_ProcessingKey"),keyField=NWS.Util.Get("cmsForms_"+blockID+"_key"),cmsFormPrefix="cmsForms_"+blockID+"_",fields=NWS.Util.QueryGetAll("input[id^='"+cmsFormPrefix+"']",processingKey);for(var f=0;f<fields.length;f++){if(fields[f]!==keyField){keyField.value=fields[f].id.substring(cmsFormPrefix.length);processingKey.removeChild(fields[f]);break}}for(var i=0;i<decodedFields.length;i++)NWS.Util.Get(decodedFields[i].FieldName).value=decodedFields[i].FieldValue},ControlHasBeenProcessed:function(processed,newCtlName){for(var ii=0;ii<processed.length;++ii)if(processed[ii]===newCtlName)return true;return false},GetCommentValue:function(ctl){switch(ctl.tagName){case"INPUT":if(ctl.type==="radio")return NWS.Fields.State.GetValue(ctl.name);else if(ctl.type==="checkbox")return ctl.checked?"yes":"no";case"TEXTAREA":return ctl.value.replace(/<|>|&lt;|&gt;|&#60;|&#62;|&#x3c;|&#x3e;|%3c|%3e/gi,"");case"SELECT":return ctl.value}},PackageByType:function(type,container){if(!container)container=document;var processedControls=[],returnValue="",ctls=container.getElementsByTagName(type);for(var ii=0;ii<ctls.length;++ii){if(ctls[ii].getAttribute("no-qs")==="1")continue;var name=ctls[ii].name||ctls[ii].getAttribute("name"),isXml=type==="textarea"&&ctls[ii].getAttribute("isXml")!==undefined?ctls[ii].getAttribute("isXml"):null;if(name&&(name.indexOf("upl_C")===0||name.indexOf("cmsForms_")===0||name.indexOf("cmsFormS_")===0)){if(_.ControlHasBeenProcessed(processedControls,name))continue;processedControls[processedControls.length]=name;if(isXml!==null){returnValue+=NWS.Xml.MakeStartTag(name,[{name:"isXml",value:isXml}],true);returnValue+=_.GetCommentValue(ctls[ii]);returnValue+=NWS.Xml.MakeEndTag(name,true)}else returnValue+=NWS.Xml.MakeTag(name,_.GetCommentValue(ctls[ii]),null,true)}}return returnValue},PackageFormData:function(blockID){var containerControl=NWS.Util.Get("DataDiv_"+blockID),packagedData=[NWS.Xml.MakeStartTag("Data",null,false),_.PackageByType("select",containerControl),_.PackageByType("input",containerControl),_.PackageByType("textarea",containerControl),NWS.Xml.MakeTag("Captcha",_.ExtractCaptchaInfo(containerControl,blockID),null,false),NWS.Xml.MakeEndTag("Data")];return packagedData.join("")},SFExtractMessageControl:function(suffix){var ctlName="cmsForms_DataNotProvided";if(suffix)ctlName+="_"+suffix;return NWS.Util.Get(ctlName)},SFFindMessage:function(msgCtl,msgName){var message=NWS.Util.Get(msgName);if(message)msgCtl.style.display="block";return message},SFMessageAreaHasMessage:function(suffix){var ctl=_.SFExtractMessageControl(suffix);var embeddedDivs=ctl.getElementsByTagName("DIV");for(var ii=0;ii<embeddedDivs.length;++ii)if(embeddedDivs[ii].className&&embeddedDivs[ii].className==="SFMessage")return true;return false},SFMessageAreaFinalAdjust:function(suffix){var msgCtl=_.SFExtractMessageControl(suffix);if(_.SFMessageAreaHasMessage(suffix)){msgCtl.style.display="block";if(msgCtl.getAttribute("useClass")==="1")msgCtl.classList.remove("error");else msgCtl.style.display="none"}else{if(msgCtl.getAttribute("useClass")==="1")msgCtl.classList.add("error");else msgCtl.style.display="none"}},SFAddMessage:function(msgName,msgText,suffix){var msgCtl=_.SFExtractMessageControl(suffix);if(_.SFFindMessage(msgCtl,msgName))return;var newMessage=document.createElement("DIV");newMessage.className="SFMessage";newMessage.id=msgName;newMessage.textContent=msgText;msgCtl.appendChild(newMessage);if(msgCtl.getAttribute("useClass")==="1")msgCtl.classList.add("error");else msgCtl.style.display="block";return true},SFRemoveMessage:function(msgName,suffix){var msgCtl=_.SFExtractMessageControl(suffix);var ctlToRemove=_.SFFindMessage(msgCtl,msgName);if(ctlToRemove===null||msgCtl===null)return;msgCtl.removeChild(ctlToRemove);if(msgCtl.getElementsByTagName("DIV").length>0)return;if(msgCtl.getAttribute("useClass")==="1")msgCtl.classList.remove("error");else msgCtl.style.display="none"},SFDisplayMessage:function(msgName,message,suffix){if(_.SFFindMessage(_.SFExtractMessageControl(suffix),msgName))return;_.SFAddMessage(msgName,message,suffix)},SFRespondToValidation:function(testHasPassed,msgName,message,ctlName,suffix){var containingDiv=null;var errorCtl=NWS.Util.Get(ctlName+"_Error");if(errorCtl){containingDiv=errorCtl;while(containingDiv&&containingDiv.tagName!=="DIV")containingDiv=containingDiv.parentNode;if(containingDiv&&containingDiv.tagName!=="DIV")containingDiv=null}if(testHasPassed){_.SFRemoveMessage(msgName,suffix);if(containingDiv)containingDiv.classList.remove("messageOn");return true}else{_.SFDisplayMessage(msgName,message,suffix);if(containingDiv)containingDiv.classList.add("messageOn");return false}},SFValidateAll:function(ctl){var allPassed=true;if(window.FormSpecificValidation)allPassed&=FormSpecificValidation();allPassed&=_.ActionByType("select","validate",document,null);allPassed&=_.ActionByType("input","validate",document,null);allPassed&=_.ActionByType("textarea","validate",document,null);if(allPassed)ctl.form.submit()},SFValidateControl:function(ctlName,suffix){var messageName="alert_"+ctlName,controlIsValid=true,ctl=NWS.Util.Get(ctlName),displayName=ctlName.substring(ctlName.indexOf('_')+1),bIsRequired=false;if(ctl){if(ctl.attributes["errorMessage"]&&ctl.attributes["errorMessage"].value!=="")displayName=ctl.attributes["errorMessage"].value;else if(ctl.attributes["errormessage"]&&ctl.attributes["errormessage"].value!=="")displayName=ctl.attributes["errormessage"].value;bIsRequired=((ctl.attributes["isRequired"]&&(ctl.attributes["isRequired"].value==='1'||ctl.attributes["isRequired"].value==='true'||ctl.attributes["isRequired"].value==="isRequired"))||(ctl.attributes["isrequired"]&&(ctl.attributes["isrequired"].value==='1'||ctl.attributes["isrequired"].value==='true'||ctl.attributes["isrequired"].value==="isrequired")))}if(ctl&&ctl.tagName==="SELECT"){if(bIsRequired){var selectedValue=SFGetSelectValue(ctlName);if(!selectedValue||selectedValue==="")controlIsValid=false}_.SFRespondToValidation(controlIsValid,messageName,displayName,ctlName,suffix)}else if(ctl&&ctl.tagName==='INPUT'&&ctl.type==='checkbox'){if(bIsRequired){controlIsValid=(ctl.getAttribute("rel")!==null)?SFValidateCheckboxesByRel(ctl.getAttribute("rel")):ctl.checked;_.SFRespondToValidation(controlIsValid,messageName,displayName,ctlName,suffix)}}else if(!ctl||(ctl.tagName==='INPUT'&&ctl.type==='radio')){if(!ctl){var ctlGroup=document.getElementsByName(ctlName);if(ctlGroup&&ctlGroup.length>0){bIsRequired=((ctlGroup[0].attributes["isRequired"]&&(ctlGroup[0].attributes["isRequired"].value==='true'||ctlGroup[0].attributes["isRequired"].value==="isRequired"))||(ctlGroup[0].attributes["isrequired"]&&(ctlGroup[0].attributes["isrequired"].value==='true'||ctlGroup[0].attributes["isrequired"].value==="isrequired")));var firstCtl=ctlGroup[0];if(firstCtl.attributes["errorMessage"]&&firstCtl.attributes["errorMessage"].value!=="")displayName=firstCtl.attributes["errorMessage"].value;else if(firstCtl.attributes["errormessage"]&&firstCtl.attributes["errormessage"].value!=="")displayName=firstCtl.attributes["errormessage"].value}}if(bIsRequired){var selectedRadioValue=NWS.Fields.State.GetValue(ctlName);if(!selectedRadioValue||selectedRadioValue==="")controlIsValid=false}_.SFRespondToValidation(controlIsValid,messageName,displayName,ctlName,suffix)}else{var vType=ctl.attributes["validationType"]?ctl.attributes["validationType"].value:"None",bNeedsValidation=vType!=="None",bIsOptional=!bIsRequired&&bNeedsValidation,regexp=ctl.getAttribute("regExp")||ctl.getAttribute("regexp");if(bIsRequired&&!NWS.Fields.Validate.HasValue(ctlName))controlIsValid=false;else if(bIsOptional&&!NWS.Fields.Validate.HasValue(ctlName))controlIsValid=true;else if(bNeedsValidation&&vType==="Function"){controlIsValid=false;try{controlIsValid=NWS.Modules.ExecuteFunctionByName(regexp,window,[ctlName])}catch(e){if(e.message==="Cannot call method 'apply' of undefined")displayName+=" (could not locate validation function)";else displayName+=" (error calling '"+regexp+"': "+e.message+")"}}else if(bNeedsValidation&&!NWS.Fields.Validate.MatchesRegEx(ctlName,regexp))controlIsValid=false;_.SFRespondToValidation(controlIsValid,messageName,displayName,ctlName,suffix)}return controlIsValid},SFConfirmForm:function(blockID){_.SFDisableAll(NWS.Util.Get("DataDiv_"+blockID));NWS.Util.Get("VerifyMessage_"+blockID).style.display="block";NWS.Util.Get("SubmitButtons_"+blockID).style.display="none";NWS.Util.Get("ConfirmButtons_"+blockID).style.display="block";NWS.Util.Get("cmsForms_DataNotProvided_"+blockID).style.display="none";NWS.Util.Get("DataDiv_"+blockID).style.display="block"},ActionByType:function(type,action,container,suffix){if(!container)container=document;var ctls=container.getElementsByTagName(type);var returnValue=true;for(var ii=0;ii<ctls.length;++ii){var name=ctls[ii].name||ctls[ii].getAttribute("name");if(name&&(name.indexOf("cmsForms_")===0||name.indexOf("cmsFormS_")===0))switch(action){case"disable":_.SFDisableControl(name);break;case"enable":_.SFEnableControl(name);break;case"validate":returnValue&=_.SFValidateControl(name,suffix);break;case"clearCheck":if(ctls[ii].type==="checkbox")ctls[ii].checked=false}}return returnValue},MaskEdit:function(ctl){if(!ctl)return;ctl.readOnly=true;ctl.classList.add("hideBorders")},UnMaskEdit:function(ctl){if(!ctl)return;ctl.readOnly=false;ctl.classList.remove("hideBorders")},SFEnableControl:function(ctlName){var ctl=NWS.Util.Get(ctlName);if(ctl&&ctl.tagName==="SELECT"){ctl.style.display="block";if(NWS.Util.Get(ctl.id+"_mask"))NWS.Util.Get(ctl.id+"_mask").parentNode.removeChild(NWS.Util.Get(ctl.id+"_mask"))}else if(ctl&&ctl.tagName==='INPUT'&&ctl.type==='checkbox')ctl.disabled=false;else if(!ctl||(ctl.tagName==='INPUT'&&ctl.type==='radio')){var ctlGroup=document.getElementsByName(ctlName);for(var ii=0;ii<ctlGroup.length;++ii)ctlGroup[ii].disabled=false}else _.UnMaskEdit(ctl)},SFDisableControl:function(ctlName){var ctl=NWS.Util.Get(ctlName);if(ctl&&ctl.tagName==="SELECT"){var parentNode=ctl.parentNode;if(!parentNode)return window.alert("No parent element found for "+ctlName);var inputControl=document.createElement("input");if(!inputControl)return window.alert("Unable to create element for "+ctlName);inputControl.id=ctl.id+"_mask";if(!ctl.multiple&&ctl.selectedIndex>=0)inputControl.value=ctl.options[ctl.selectedIndex].text;else{var str="";for(var ii=0;ii<ctl.length;++ii)if(ctl[ii].selected)str+=(str.length>0?", ":"")+ctl[ii].text;inputControl.value=str}inputControl.className=ctl.className;parentNode.insertBefore(inputControl,ctl);_.MaskEdit(inputControl);ctl.style.display="none"}else if(ctl&&ctl.tagName==='INPUT'&&ctl.type==='checkbox')ctl.disabled=true;else if(!ctl||(ctl.tagName==='INPUT'&&ctl.type==='radio')){var ctlGroup=document.getElementsByName(ctlName);for(var jj=0;jj<ctlGroup.length;++jj)ctlGroup[jj].disabled=true}else _.MaskEdit(ctl)},SFDisableAll:function(container){if(!container)container=document;_.ActionByType("input","disable",container,null);_.ActionByType("textarea","disable",container,null);_.ActionByType("select","disable",container,null)},SFEnableAll:function(container){if(!container)container=document;_.ActionByType("input","enable",container,null);_.ActionByType("textarea","enable",container,null);_.ActionByType("select","enable",container,null)},SFGeneralValidate:function(docID,blockID,useCaptcha,specialValidationFunc){var containerControl=NWS.Util.Get("DataDiv_"+blockID),dataErrorDiv=NWS.Util.Get("cmsForms_DataNotProvided_"+blockID);if(!containerControl){window.alert("Form Container is Missing");return false}NWS.Util.Get(containerControl.id).style.display="none";var allPassed=true;if(specialValidationFunc)allPassed&=specialValidationFunc(blockID,docID);allPassed&=_.ActionByType("select","validate",containerControl,blockID);allPassed&=_.ActionByType("input","validate",containerControl,blockID);allPassed&=_.ActionByType("textarea","validate",containerControl,blockID);if(useCaptcha==="1")allPassed&=_.ClientSideCaptchaValidate(blockID,blockID);if(!allPassed){_.ResetCaptcha(blockID);NWS.Util.Get(containerControl.id).style.display="block";if(dataErrorDiv)NWS.Util.ScrollTo(dataErrorDiv);else NWS.Util.ScrollTo(NWS.Util.Get(containerControl.id))}return allPassed},InitializeField:function(fieldDiv,dataValue){var type=fieldDiv.getAttribute("fieldType"),name=fieldDiv.getAttribute("fieldName"),field=NWS.Util.QueryGet("#cmsForms_"+name,fieldDiv);if(!field||dataValue==="")return;switch(type){case"checkbox":field.checked=(dataValue!==0&&dataValue!=="no"&&dataValue!=="off"&&dataValue!==false);break;case"date":var d=_.ParseDateTime(dataValue);field.value=_.ToDateTimeString(d,true,false);break;case"datetime":var dt=_.ParseDateTime(dataValue);field.value=_.ToDateTimeString(dt,true,true);NWS.Util.QueryGet("#"+name+"_Date",fieldDiv).value=_.ToDateTimeString(dt,true,false);NWS.Util.QueryGet("#"+name+"_Time",fieldDiv).value=_.ToDateTimeString(dt,false,true);break;case"datetimerecur":var configElement=NWS.Util.QueryGet("#"+name+"_recurConfig",fieldDiv),data=JSON.parse(dataValue),pattern=new RecurrencePattern(data);field.value=pattern.ReturnXml();configElement.setAttribute("defaultValue",dataValue);configElement.value=dataValue;if(configElement.hasAttribute("skipConfirm")&&data.count!==1)configElement.removeAttribute("skipConfirm");NWS.Util.QueryGet("#"+name+"_Date",fieldDiv).value=data.startDate;NWS.Util.QueryGet("#"+name+"_Time",fieldDiv).value=data.startTime;NWS.Util.QueryGet("#"+name+"_patternLabel",fieldDiv).textContent=pattern.ReturnLabelAndEmpty();break;case"latlong":var geoData=JSON.parse(dataValue);field.value=geoData.Point;NWS.Util.QueryGet("#"+name+"_Lat",fieldDiv).value=geoData.Latitude;NWS.Util.QueryGet("#"+name+"_Long",fieldDiv).value=geoData.Longitude;break;case"dropdown":field.value=dataValue;break;case"radio":field.value=dataValue;var r=NWS.Util.QueryGetAll("input[name='"+name+"']",fieldDiv);if(r.length&&r.length>0)for(var ii=0;ii<r.length;ii++)r[ii].checked=r[ii].value===dataValue;else r.checked=r.value===dataValue;break;case"filepicker":field.value=dataValue;break;case"freeform":NWS.Util.Get(name+"_preview").innerHTML=dataValue;field.value=dataValue;break;case"textarea":field.value=dataValue;break;case"xmltextarea":field.value=dataValue;break;case"textbox":field.value=dataValue;break}},ParseDateTime:function(dateString){var dateTime=null;if(Date.parse&&!isNaN(Date.parse(dateString)))dateTime=new Date(Date.parse(dateString));return dateTime},ToDateTimeString:function(dateObj,doDate,doTime){if(dateObj===null)return"";var d=doDate?dateObj.toISOString().split('T')[0]:"",t=doTime?dateObj.toTimeString().substring(0,5):"";return[d,doDate&&doTime?" ":"",t].join("")},ParseLatitude:function(latString){let retVal={IsValid:false,Latitude:latString};if(!latString)return retVal;let latRE=/^(-)?([1-8]?[0-9]\.\d+|90\.0+)\s?([nNsS])?$/;if(latRE.test(latString)){let match=latString.match(latRE);if(match.length===4){let lat=parseFloat(match[2]),isNeg=match[1]!==undefined&&match[1].indexOf('-')>=0,isNorth=match[3]!==undefined&&(match[3].indexOf('n')>=0||match[3].indexOf('N')>=0),isSouth=match[3]!==undefined&&(match[3].indexOf('s')>=0||match[3].indexOf('S')>=0);if(isNaN(lat))return retVal;if((isNorth||isSouth)&&isNeg)return retVal;retVal.IsValid=true;retVal.Latitude=(isSouth||isNeg?lat*-1:lat).toFixed(6)}}return retVal},ParseLongitude:function(lngString){let retVal={IsValid:false,Longitude:lngString};if(!lngString)return retVal;let lngRE=/^(-)?((?:1[0-7][0-9]|[1-9]?[0-9])\.\d+|180\.0+)\s?([eEwW])?$/;if(lngRE.test(lngString)){let match=lngString.match(lngRE);if(match.length===4){let lng=parseFloat(match[2]),isNeg=match[1]&&match[1].indexOf('-')>=0,isEast=match[3]&&(match[3].indexOf('e')>=0||match[3].indexOf('E')>=0),isWest=match[3]&&(match[3].indexOf('w')>=0||match[3].indexOf('W')>=0);if(isNaN(lng))return retVal;if((isEast||isWest)&&isNeg)return retVal;retVal.IsValid=true;retVal.Longitude=(isWest||isNeg?lng*-1:lng).toFixed(6)}}return retVal}};var _ItemList={IsChanged:function(baseID){return _ItemList.GetFieldset(baseID).getAttribute("changed")==="1"},DefaultData:function(baseID){return NWS.Util.Get(baseID+"_previousData").innerHTML},PackageData:function(baseID,asText){var itemsUL=_ItemList.GetItemsUL(baseID),dataAreas=NWS.Util.QueryGetAll("li textarea",itemsUL),saveData=[];for(var i=0;i<dataAreas.length-1;i++){var dataText=dataAreas[i].textContent?dataAreas[i].textContent:dataAreas[i].innerText;if(dataText.indexOf("<Option")===0){saveData.push(dataText);continue}var dataString=dataAreas[i].innerHTML;if(dataString.trim()==="")continue;var data=JSON.parse(dataString);data.LinkParameter=data.LinkParameter.replace(/\'/gi,"&apos;");var titlePrefix="";switch(data.DocumentTypeID){case 2:titlePrefix="Page Link - ";break;case 3:titlePrefix="External Link - ";break;case 4:titlePrefix="File Link - ";break;case 5:titlePrefix="MailTo Link - ";break;case 8:titlePrefix="Data Link - ";break;case 9:titlePrefix="Tel Link - ";break}saveData.push("<Option Value='",data.LinkParameter,"' title='",titlePrefix,data.LinkParameter,"' titan-linktype='",data.DocumentTypeID,"' titan-usenewwindow='",data.TargetTypeID===102?"1":"0","'>");if(asText)saveData.push(data.Text);else saveData.push("<![CDATA[",data.Text,"]]>");saveData.push("</Option>")}return saveData.join("")},KeyUp:function(evt){NWS.Util.Event.Cancel(evt);var target=evt.target,baseID=NWS.Util.GetBaseID(target.id),key=NWS.Util.KeyValue[evt.key],item=_ItemList.GetSelectedItem(baseID);if(!key||!baseID)return;target.focus();if(key===NWS.Util.KeyValue.Insert)_ItemList.AddNew(baseID);else if(key===NWS.Util.KeyValue.Escape){_ItemList.DeSelectAll(baseID);_ItemList.EnableDisableButtons(baseID,true)}if(!item)return;if(key===NWS.Util.KeyValue.Enter||key===NWS.Util.KeyValue[""])_ItemList.Edit(baseID,evt);else if(key===NWS.Util.KeyValue.ArrowUp)_ItemList.SortUp(evt);else if(key===NWS.Util.KeyValue.ArrowDown)_ItemList.SortDown(evt);else if(key===NWS.Util.KeyValue.Delete)_ItemList.Delete(baseID,evt)},AddNew:function(baseID){var ul=NWS.Util.Get(baseID+"_options"),marker=_ItemList.GetMarker(baseID),afterSelectedLI=_ItemList.GetAfterSelectedItem(baseID);if(!ul||!marker)return;var newField=marker.cloneNode(true);newField.className="";if(afterSelectedLI)ul.insertBefore(newField,afterSelectedLI);else ul.insertBefore(newField,marker);NWS.Util.ScrollTo(newField);_ItemList.Select(null,newField);_ItemList.Edit(baseID,null)},Edit:function(baseID,evt){var baseCtl=NWS.Util.Get(baseID);if(!baseCtl)baseCtl=_.GetFieldContainer(NWS.Util.Get("cmsForms_"+baseID));if(!baseCtl)return;var editFunc=baseCtl.getAttribute("editFunc"),editArgs=JSON.parse(baseCtl.getAttribute("editArgs"));editArgs[editArgs.length]=baseID;editArgs[editArgs.length]=evt;NWS.Modules.ExecuteFunctionByName(editFunc,window,editArgs)},Delete:function(baseID,evt){var itemsUL=_ItemList.GetItemsUL(baseID),selected=_ItemList.GetSelectedItem(baseID),selectedSpan=NWS.Util.QueryGet("span.name",selected),selectedTitle=selectedSpan.textContent?selectedSpan.textContent:selectedSpan.innerText;if(itemsUL&&selected&&confirm("Are you sure you want to remove '"+selectedTitle+"' from the list?")){itemsUL.removeChild(selected);_ItemList.SetChanged(baseID);_ItemList.Select(null,itemsUL)}},SilentDelete:function(li){if(!li)return;var baseID=NWS.Util.GetBaseID(li.parentNode.id),ul=li.parentNode;if(ul.getElementsByTagName("LI").length<=2)_ItemList.Select(null,ul);else _ItemList.SelectPrev(baseID);ul.removeChild(li)},GetFieldset:function(baseID){return NWS.Util.Get(baseID+"_optionList")},FocusFieldset:function(baseID){_ItemList.GetFieldset(baseID).focus()},SetChanged:function(baseID){_ItemList.GetFieldset(baseID).setAttribute("changed","1")},GetItemsUL:function(baseID){return NWS.Util.Get(baseID+"_options")},GetSelectedItem:function(baseID){return _ItemList.GetItemsUL(baseID).querySelector("li.select")},GetAfterSelectedItem:function(baseID){var ul=_ItemList.GetItemsUL(baseID),allLIs=ul.getElementsByTagName("LI");for(var ii=0;ii<allLIs.length;++ii)if(allLIs[ii].classList.contains("select"))return allLIs[ii+1];return null},GetMarker:function(baseID){return _ItemList.GetItemsUL(baseID).querySelector("li.marker")},Select:function(evt,target){target=target||evt.target;var baseID=null;if(target.nodeName==="UL"){baseID=NWS.Util.GetBaseID(target.id);_ItemList.DeSelectAll(baseID);_ItemList.EnableDisableButtons(baseID,true);return}while(target.nodeName!=="LI")target=target.parentNode;baseID=NWS.Util.GetBaseID(target.parentNode.id);if(target.classList.contains("select")){target.classList.remove("select");_ItemList.EnableDisableButtons(baseID,true);return}_ItemList.DeSelectAll(baseID);target.classList.add("select");_ItemList.EnableDisableButtons(baseID,false)},SelectPrev:function(baseID){var ul=_ItemList.GetItemsUL(baseID),lis=ul.getElementsByTagName("LI"),idx=lis.length-2;for(var i=0;i<lis.length-1;i++)if(lis[i].classList.remove("select")){idx=i===0?lis.length-2:i-1;break}_ItemList.Select(null,lis[idx])},SelectNext:function(baseID){var ul=_ItemList.GetItemsUL(baseID),lis=ul.getElementsByTagName("LI"),idx=0;for(var i=0;i<lis.length-1;i++)if(lis[i].classList.remove("select")){idx=i===lis.length-2?0:i+1;break}_ItemList.Select(null,lis[idx])},DeSelectAll:function(baseID){var ul=_ItemList.GetItemsUL(baseID),lis=ul.getElementsByTagName("LI");for(var i=0;i<lis.length;i++)lis[i].classList.remove("select")},EnableDisableButtons:function(baseID,isDisabled){var edt=NWS.Util.Get(baseID+"_editButton"),del=NWS.Util.Get(baseID+"_deleteButton"),sUp=NWS.Util.Get(baseID+"_sortUp"),sDn=NWS.Util.Get(baseID+"_sortDown");edt.disabled=isDisabled;del.disabled=isDisabled;sUp.disabled=isDisabled;sUp.className=isDisabled?"sortUp disabled":"sortUp";sDn.disabled=isDisabled;sDn.className=isDisabled?"sortDown disabled":"sortDown";_ItemList.FocusFieldset(baseID)},SortUp:function(evt){NWS.Util.Event.Cancel(evt,true);var target=evt.target,baseID=NWS.Util.GetBaseID(target.id),ul=_ItemList.GetItemsUL(baseID),moveMe=_ItemList.GetSelectedItem(baseID);_ItemList.FocusFieldset(baseID);if(!moveMe)return;var allKids=ul.getElementsByTagName("LI");for(var ii=0;ii<allKids.length;++ii){if(allKids[ii]===moveMe&&ii>0){allKids[ii].parentNode.insertBefore(allKids[ii],allKids[ii-1]);_ItemList.SetChanged(baseID);return}if(allKids[ii]===moveMe)return}},SortDown:function(evt){NWS.Util.Event.Cancel(evt,true);var target=evt.target,baseID=NWS.Util.GetBaseID(target.id),ul=_ItemList.GetItemsUL(baseID),moveMe=_ItemList.GetSelectedItem(baseID);_ItemList.FocusFieldset(baseID);if(!moveMe)return;var allKids=ul.getElementsByTagName("LI");for(var ii=0;ii<allKids.length-2;++ii){if(allKids[ii]===moveMe&&ii<allKids.length-2){allKids[ii].parentNode.insertBefore(allKids[ii],ii>=(allKids.length-2)?null:allKids[ii+2]);_ItemList.SetChanged(baseID);return}if(allKids[ii]===moveMe)return}}};var _freeform={OnComplete:function(data){if(!data.BaseID||!NWS.Util.Get(data.BaseID))return;var element=NWS.Util.Get(data.BaseID),preview=NWS.Util.Get(element.getAttribute("FieldName")+"_preview");NWS.Util.ReplaceHtml(preview,data.FreeformData);element.value=data.FreeformData}};var _linkEditor={OnComplete:function(baseID,data){if(!baseID||!NWS.Util.Get(baseID))return;var element=NWS.Util.Get(baseID),type=_.GetFieldContainer(element).getAttribute("fieldType");if(type==="filepicker")element.value=data.LinkParameter;else{let fieldName=element.getAttribute("FieldName"),selected=_ItemList.GetSelectedItem(fieldName),linkedTextSpan=selected.querySelector("span.name"),linkSpan=selected.querySelector("span.link"),textArea=selected.querySelector("textarea");var titlePrefix="* ";switch(data.DocumentTypeID){case 2:titlePrefix+="Page Link - ";break;case 3:titlePrefix+="External Link - ";break;case 4:titlePrefix+="File Link - ";break;case 5:titlePrefix+="MailTo Link - ";break;case 8:titlePrefix+="Data Link - ";break;case 9:titlePrefix+="Tel Link - ";break}selected.setAttribute("Value",data.LinkParameter);selected.setAttribute("title",titlePrefix+data.LinkParameter);selected.setAttribute("titan-linktype",data.DocumentTypeID);selected.setAttribute("titan-usenewwindow",data.TargetTypeID===102?"1":"0");if(linkedTextSpan)linkedTextSpan.textContent=data.Text;if(linkSpan)linkSpan.textContent=data.LinkParameter;textArea.innerHTML=JSON.stringify(data);_ItemList.SetChanged(fieldName);_ItemList.FocusFieldset(fieldName)}}};return{Init:function(jsModules,callbacks){NWS.Modules.LoadResources(jsModules,callbacks);if(!window["DataEditor"])window["DataEditor"]=NWS.Block.DataEditor;if(!window["ItemList"])window["ItemList"]=NWS.Block.DataEditor.ItemList},OpenDialog:function(name,evt){var field=NWS.Util.Get("cmsForms_"+name),container=_.GetFieldContainer(field),type=container.getAttribute("fieldType"),blockID=container.getAttribute("blockID"),processingKey=NWS.Util.Get("cmsFormsControl_"+blockID+"_ProcessingKey");var args={Title:field.getAttribute("title"),Size:"full",FieldID:field.id,FieldName:field.getAttribute("FieldName"),FieldType:type,DocID:processingKey.getAttribute("docID"),ItemID:processingKey.getAttribute("itemID"),BlockID:blockID,EncodedData:NWS.Ajax.UrlToken.Encode(_.GetInitData(type,field.id))};args.ReturnCallback=type==="freeform"?_freeform.OnComplete:_linkEditor.OnComplete;if(type!=="freeform"&&!evt){args.Ctl=_ItemList.GetSelectedItem(name);args.SilentDelete=_ItemList.SilentDelete}NWS.Wkst.Dialog.Open("","/Edit/FieldData",args)},HandleSubmit:function(docID,blockID,doConfirm,useCaptcha,submitAction){_.HandleSubmit(docID,blockID,doConfirm,useCaptcha,submitAction)},Submit:function(docID,blockID,doConfirm,useCaptcha,submitAction){if(useCaptcha==="1"){_.CheckForInvisibleRecaptchaData(docID,blockID,doConfirm,useCaptcha,submitAction);return}_.HandleSubmit(docID,blockID,doConfirm,useCaptcha,submitAction)},SFReturnToEdit:function(blockID){_.SFEnableAll(NWS.Util.Get("DataDiv_"+blockID));NWS.Util.Get("VerifyMessage_"+blockID).style.display="none";NWS.Util.Get("SubmitButtons_"+blockID).style.display="block";NWS.Util.Get("ConfirmButtons_"+blockID).style.display="none";NWS.Util.Get("DataDiv_"+blockID).style.display="block"},SFFormSubmitComplete:function(blockID,submitAction,results,context,methodName){_.ResetCaptcha(blockID);if(submitAction==="remotePost"&&NWS.Util.Get("postURL_"+blockID)){NWS.Util.QueryGet("form#routerForm").setAttribute("action",NWS.Util.Get("postURL_"+blockID).value);return NWS.Util.QueryGet("form#routerForm").submit()}if(!results.status){NWS.Util.Get("DataDiv_"+blockID).style.display="block";_.SFRespondToValidation(false,"formsubmit",results.message,"foo",blockID);_.ResetProcessingKey(blockID,results.data);if(NWS.Util.Get("cmsForms_submitUDF"))NWS.Util.Get("SubmitButtons_"+String(blockID)).style.display="none"}else if(NWS.Util.Get("ThankYouDiv_"+blockID)){let thankYouMessage=NWS.Util.Get("ThankYouDiv_"+blockID);thankYouMessage.style.display="block";NWS.Util.ScrollTo(thankYouMessage)}else if(NWS.Util.Get("followupUrl_"+blockID)){var followupUrl=NWS.Util.Get("followupUrl_"+blockID).value,lastIndex=followupUrl.lastIndexOf("DataID="),dataIDParam=(results.docID&&results.docID>0&&lastIndex!==-1&&lastIndex===(followupUrl.length-7))?results.docID:"";location.href=NWS.Util.Get("followupUrl_"+blockID).value+dataIDParam}},DialogSubmitComplete:function(blockID,submitAction,results){if(submitAction==="remotePost"&&NWS.Util.Get("postURL_"+blockID)){NWS.Util.QueryGet("form#routerForm").setAttribute("action",NWS.Util.Get("postURL_"+blockID).value);return NWS.Util.QueryGet("form#routerForm").submit()}if(!results.status){NWS.Wkst.Dialog.Loading(false);var submitButtons=document.querySelectorAll("div[id^='SubmitButtons_']");for(var s=0;s<submitButtons.length;s++)submitButtons[s].style.display="none";_.ResetCaptcha(blockID);NWS.Util.Get("DataDiv_"+blockID).style.display="block";_.SFRespondToValidation(false,"formsubmit",results.message,"foo",blockID);_.ResetProcessingKey(blockID,results.data)}else if(NWS.Util.Get("ThankYouDiv_"+blockID))window.location.reload(true);else if(NWS.Util.Get("followupUrl_"+blockID)){var followupUrl=NWS.Util.Get("followupUrl_"+blockID).value,lastIndex=followupUrl.lastIndexOf("DataID="),dataIDParam=results.docID&&results.docID>0&&lastIndex!==-1&&lastIndex===followupUrl.length-7?results.docID:"";window.location.href=NWS.Util.Get("followupUrl_"+blockID).value+dataIDParam}},FinalFormSubmit:function(docID,blockID,submitAction){NWS.Block.DataEditor.SFReturnToEdit(blockID);NWS.Util.Get("DataDiv_"+blockID).style.display="none";_.HandleProcessingKey(blockID);var encodedFields=JSON.parse(NWS.Util.Get("cmsFormsControl_"+blockID+"_decode").value);for(var i=0;i<encodedFields.length;i++)NWS.Util.Get(encodedFields[i].FieldName).value=encodedFields[i].FieldValue;var packagedData=_.PackageFormData(blockID),itemID=NWS.Util.Get("cmsFormsControl_"+blockID+"_ProcessingKey").getAttribute("itemID"),ajaxArgs={docID,blockID,itemID,encodedData:NWS.Ajax.UrlToken.Encode(packagedData),encodedFields:JSON.stringify(encodedFields)};var callbackFunc="NWS.Block.DataEditor.SFFormSubmitComplete";if(NWS.Wkst.Dialog.GetEditor()!==null&&NWS.Block.DataEditorDialog)callbackFunc="NWS.Block.DataEditor.DialogSubmitComplete";var callback=NWS.Ajax.QueuedCallback("DataEditorSubmit"+blockID,function(result){_.FinalFormSubmitCallback(result,callbackFunc,[blockID,submitAction])});_.SFRemoveMessage("formsubmit",blockID);NWS.Ajax.Post("/DataEditorDisplayAjax/ProcessSubmit",ajaxArgs,"json",callback)},PopulateCallback:function(blockID,responseAsJSON,responseAsXml,responseAsText){_.RedirectIfNeeded(responseAsJSON);if(!responseAsJSON)return;var processingKey=NWS.Util.Get("cmsFormsControl_"+blockID+"_ProcessingKey"),parentNode=processingKey.parentNode;processingKey.setAttribute("itemID",responseAsJSON.itemID);var updates=NWS.Util.QueryGetAll("div.dataField[fieldtype='freeform'], div.dataField[fieldtype='filepicker'], div.dataField[fieldtype='linkpicker'], div.dataField[fieldtype='multifilepicker']",parentNode);for(var ii=0;ii<updates.length;ii++)updates[ii].setAttribute("blockID",blockID);var inputs=responseAsJSON.inputs;if(inputs){for(var i=0;i<inputs.length;i++){var field=NWS.Util.Get(inputs[i].FieldID);if(!field)continue;if(field.tagName==="TEXTAREA")field.value=inputs[i].InnerHtml;else field.innerHTML=inputs[i].InnerHtml}}var fieldContent=responseAsJSON.fieldContent;if(fieldContent.length===0)return;for(var f=0;f<fieldContent.length;f++){var fieldDiv=NWS.Util.QueryGet("div[fieldName='"+fieldContent[f].FieldName+"']",parentNode);if(fieldDiv)_.InitializeField(fieldDiv,fieldContent[f].FieldValue.trim())}},UpdateDateTime:function(fieldName){var field=document.getElementById("cmsForms_"+fieldName),date=document.getElementById(fieldName+"_Date"),time=document.getElementById(fieldName+"_Time");field.value=date.value+" "+time.value},UpdateLatLong:function(fieldName){var field=document.getElementById("cmsForms_"+fieldName),lat=NWS.Fields.State.GetValue(fieldName+"_Lat"),lng=NWS.Fields.State.GetValue(fieldName+"_Long");if(lat===""&&lng===""){field.value="POINT EMPTY";return}var pLat=_.ParseLatitude(lat).Latitude,pLng=_.ParseLongitude(lng).Longitude;field.value="POINT ("+pLng.Longitude+" "+pLat.Latitude+")"},ItemList:{AddNew:function(fieldName){_ItemList.AddNew(fieldName)},Edit:function(fieldName,evt){_ItemList.Edit(fieldName,evt)},Delete:function(fieldName,evt){_ItemList.Delete(fieldName,evt)},SortUp:function(evt){_ItemList.SortUp(evt)},SortDown:function(evt){_ItemList.SortDown(evt)},KeyUp:function(evt){_ItemList.KeyUp(evt)},Select:function(evt){_ItemList.Select(evt)}}}})